<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Server-sent events</title>
    <style>
        p {
            margin-top: 0.5em;
            margin-bottom: 0.5em;
        }

    </style>

    <script src="/chattelite-client.min.js"></script>
</head>

<body>
    <div id="root" style="max-height:90vh;overflow-y: auto;"></div>
    <script defer>
        ChatteliteClient.init("http://127.0.0.1:8000");

        let JWT;
        let CONVERSATION_ID;
        let event_source;
        let root = document.getElementById("root");


        async function connect_to_conversation() {
            console.log("CONVERSATION_ID", CONVERSATION_ID);

            let previous_events = await ChatteliteClient.Endpoints.get_conversation_events({ session_token: JWT }, CONVERSATION_ID);
            console.log(previous_events);

            for (let e of previous_events.events) {
                let data = document.createElement("p");
                data.innerText = "old: " + JSON.stringify(e);
                root.appendChild(data);
                data.scrollIntoView();
            }

            event_source = new EventSourceWithHeaders("http://127.0.0.1:8000/conversation/" + CONVERSATION_ID + "/sse", { headers: { "X-Access-Token": JWT } });
            event_source.onmessage = (event) => {
                let data = document.createElement("p");
                let time = new Date().toLocaleTimeString();
                data.innerText = time + ": " + event.data;
                root.appendChild(data);
                data.scrollIntoView();
            }
        }

        async function start() {
            await fetch("/login").then(async r => {
                if (r.status != 200) throw "error"

                let data = await r.json();

                console.log("login", data);

                JWT = data.jwt;
                CONVERSATION_ID = data.conversation_id;

            }).then(connect_to_conversation);
        }

        start();

        function send(e) {
            ChatteliteClient.Endpoints.send_message({ session_token: JWT }, CONVERSATION_ID, {
                content: message
            });
            message = "";
            document.getElementById("message").value = "";
        }

        async function join(e) {
            fetch("/join", {
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                method: "POST",
                body: JSON.stringify({
                    conversation_id: CONVERSATION_ID
                })
            }
            ).then(_ => {
                connect_to_conversation();
            })
        }

        function leave(e) {
            fetch("/leave", {
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                method: "POST",
                body: JSON.stringify({
                    conversation_id: CONVERSATION_ID
                })
            })
            if (event_source) {
                event_source.close();
            }
            root.innerHTML = "";
        }

        let start_typing = null;
        let stop_typing = null;

        function input(e) {
            message = e.target.value;
            if (!start_typing) {
                ChatteliteClient.Endpoints.start_typing({ session_token: JWT }, CONVERSATION_ID);
                start_typing = setTimeout(_ => start_typing = null, 2000);
            }
            if (stop_typing) clearTimeout(stop_typing);
            stop_typing = setTimeout(_ => {
                ChatteliteClient.Endpoints.stop_typing({ session_token: JWT }, CONVERSATION_ID);
            }, 1000);
        }

        let message = "";
    </script>

    <input type="text" id="message" oninput="input(event)">
    <button onclick="send(event)">send</button>

    <div>
        <button onclick="join(event)">JOIN</button>
        <button onclick="leave(event)">LEAVE</button>
    </div>
</body>

</html>
